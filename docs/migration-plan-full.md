# План полноценной миграции на KB Labs Platform

Этот документ описывает шаги для полной миграции `kb-labs-ai-review` на стабильные рельсы KB Labs Platform.

## Текущее состояние

После начального рефакторинга выполнено:
- ✅ Очистка артефактов сборки
- ✅ Частичная миграция утилит на `@kb-labs/core-sys`
- ✅ Унификация структуры пакетов
- ⚠️ Прямые импорты из `@kb-labs/core-sys` (нужно использовать фасад `@kb-labs/core`)
- ⚠️ Sync версии `findRepoRoot()` все еще используются
- ⚠️ Конфигурация не использует `loadBundle()`

## Цель миграции

Полная миграция на стандартные паттерны KB Labs:
1. Использование `@kb-labs/core` как единой точки входа (ADR-0005)
2. Async-first подход для всех I/O операций
3. Конфигурация через `@kb-labs/core-bundle.loadBundle()`
4. Соответствие паттернам из `kb-labs-audit` и `kb-labs-analytics`

## План миграции

### Фаза 1: Использование @kb-labs/core фасада

**Проблема**: Прямые импорты из `@kb-labs/core-sys` нарушают принцип стабильности (ADR-0005).

**Решение**: Использовать фасад `@kb-labs/core` для всех импортов.

**Файлы для изменения**:
- `packages/cli/src/cli-utils.ts` - заменить импорты

```typescript
// Было:
import { findRepoRoot as findRepoRootCore, toAbsolute } from '@kb-labs/core-sys'

// Станет:
import { findRepoRoot as findRepoRootCore, toAbsolute } from '@kb-labs/core'
```

### Фаза 2: Полная async-миграция

**Проблема**: Sync версия `findRepoRoot()` используется в 16 файлах как константа `REPO_ROOT`.

**Решение**: Постепенная миграция на async версию с сохранением обратной совместимости.

**Подход**:
1. Создать async-версии функций, которые используют `findRepoRoot()`
2. Обновить точки входа (CLI команды) на async
3. Оставить sync версию как deprecated на 2 минорных релиза

**Файлы для миграции** (16 файлов):
- Все файлы с `const REPO_ROOT = findRepoRoot()` должны стать async
- CLI команды должны стать async от корня

### Фаза 3: Миграция конфигурации на loadBundle

**Проблема**: Кастомная загрузка конфигурации через `.ai-reviewrc.json`.

**Решение**: Использовать стандартный `loadBundle()` из `@kb-labs/core-bundle`.

**Требования**:
1. Расширить схему профилей для поддержки `products.review.config`
2. Адаптировать `ResolvedConfig` к формату bundle
3. Обновить все места использования конфигурации

**Пример структуры профиля**:
```json
{
  "name": "frontend",
  "kind": "review",
  "scope": "repo",
  "version": "1.0.0",
  "products": {
    "review": {
      "enabled": true,
      "config": {
        "provider": "local",
        "failOn": "major",
        "maxComments": 7,
        "out": {
          "root": ".ai-review",
          "contextDir": "context",
          "reviewsDir": "reviews"
        },
        "context": {
          "includeADR": true,
          "includeBoundaries": true,
          "maxBytes": 1500000
        },
        "analytics": {
          "enabled": false,
          "mode": "byDay",
          "privacy": "team"
        }
      }
    }
  },
  "sources": {
    "rules": ["docs/rules/rules.json"],
    "handbook": ["docs/handbook/**/*.md"],
    "adr": ["docs/adr/**/*.md"]
  }
}
```

**Файлы для изменения**:
- `packages/cli/src/config/config-loader.ts` - реализовать `loadConfigNew()`
- `packages/cli/src/config/config.ts` - адаптировать под bundle формат
- Все профили в `packages/profiles/*/` - добавить `profile.json` с новой структурой

### Фаза 4: Использование стандартных паттернов

**Из kb-labs-audit**:
- ✅ Использование `@kb-labs/shared-profiles.resolveProfile()`
- ✅ Async-first подход в конфигурации
- ✅ Единообразная структура package.json

**Из kb-labs-analytics**:
- ✅ Четкое разделение на core/cli/adapters
- ✅ Использование событийной модели

**Что еще нужно**:
- Проверить использование `@kb-labs/shared-profiles` для загрузки профилей
- Использовать стандартные типы из `@kb-labs/core-types`

### Фаза 5: Тестирование и валидация

**Критерии готовности**:
- [ ] Все тесты проходят
- [ ] `pnpm type-check` без ошибок
- [ ] `pnpm lint` без критических ошибок
- [ ] `pnpm build` успешен
- [ ] Drift-check проходит (`pnpm devkit:check`)
- [ ] Конфигурация загружается через bundle
- [ ] Все I/O операции async

## Порядок выполнения

### Этап 1: Фасад @kb-labs/core (1-2 часа)
1. Обновить зависимости: добавить `@kb-labs/core` если нет
2. Заменить импорты в `cli-utils.ts`
3. Проверить компиляцию и тесты

### Этап 2: Async миграция (4-6 часов)
1. Создать async-обертки для функций с `REPO_ROOT`
2. Обновить CLI команды на async
3. Обновить тесты
4. Убедиться в обратной совместимости

### Этап 3: Bundle конфигурация (6-8 часов)
1. Расширить схему профилей в `@kb-labs/profile-schemas`
2. Создать миграционный скрипт для существующих профилей
3. Реализовать `loadConfigNew()` через bundle
4. Обновить все использования
5. Тестирование

### Этап 4: Финальная полировка (2-3 часа)
1. Проверить соответствие паттернам других продуктов
2. Обновить документацию
3. Финальное тестирование
4. PR и code review

## Риски и митигация

**Риск 1**: Breaking changes при миграции конфигурации
- **Митигация**: Сохранить поддержку `.ai-reviewrc.json` на переходный период (2 релиза)

**Риск 2**: Проблемы с async миграцией
- **Митигация**: Постепенная миграция, тестирование на каждом этапе

**Риск 3**: Зависимость от расширения схемы профилей
- **Митигация**: Можно начать миграцию без полной поддержки bundle, с fallback на legacy

## Ожидаемые результаты

После завершения миграции:
- ✅ Все импорты через `@kb-labs/core` фасад
- ✅ Полностью async I/O
- ✅ Конфигурация через стандартный bundle API
- ✅ Соответствие паттернам других продуктов
- ✅ Стабильная основа для дальнейшего развития

## Дальнейшие улучшения

После базовой миграции:
- Использование стандартных типов из `@kb-labs/core-types`
- Интеграция с `@kb-labs/cli` для единообразного UX
- Оптимизация bundle размера (tree-shaking)
- Улучшение тестового покрытия



